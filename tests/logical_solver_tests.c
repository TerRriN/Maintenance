#include <CUnit/Basic.h>
#include "logical_solver.h"

int init_suite(void)
{
    printf("\n");
    return 0;
}
int clean_suite(void) { return 0; }

static char test_board_empty_9[9][9] = {
    {'0','0','0', '0','0','0', '0','0','0'},
    {'0','0','0', '0','0','0', '0','0','0'},
    {'0','0','0', '0','0','0', '0','0','0'},
    {'0','0','0', '0','0','0', '0','0','0'},
    {'0','0','0', '0','0','0', '0','0','0'},
    {'0','0','0', '0','0','0', '0','0','0'},
    {'0','0','0', '0','0','0', '0','0','0'},
    {'0','0','0', '0','0','0', '0','0','0'},
    {'0','0','0', '0','0','0', '0','0','0'}
};

static char test_board_partial_9[9][9] = {
    {'5','3','0', '0','7','0', '0','0','0'},
    {'6','0','0', '1','9','5', '0','0','0'},
    {'0','9','8', '0','0','0', '0','6','0'},
    {'8','0','0', '0','6','0', '0','0','3'},
    {'4','0','0', '8','0','3', '0','0','1'},
    {'7','0','0', '0','2','0', '0','0','6'},
    {'0','6','0', '0','0','0', '2','8','0'},
    {'0','0','0', '4','1','9', '0','0','5'},
    {'0','0','0', '0','8','0', '0','7','9'}
};

static char test_board_full_9[9][9] = {
    {'5','3','4', '6','7','8', '9','1','2'},
    {'6','7','2', '1','9','5', '3','4','8'},
    {'1','9','8', '3','4','2', '5','6','7'},
    {'8','5','9', '7','6','1', '4','2','3'},
    {'4','2','6', '8','5','3', '7','9','1'},
    {'7','1','3', '9','2','4', '8','5','6'},
    {'9','6','1', '5','3','7', '2','8','4'},
    {'2','8','7', '4','1','9', '6','3','5'},
    {'3','4','5', '2','8','6', '1','7','9'}
};

static char test_board_empty_16[16][16] = {
    {'0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0'},
    {'0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0'},
    {'0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0'},
    {'0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0'},
    {'0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0'},
    {'0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0'},
    {'0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0'},
    {'0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0'},
    {'0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0'},
    {'0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0'},
    {'0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0'},
    {'0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0'},
    {'0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0'},
    {'0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0'},
    {'0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0'}, 
    {'0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0'}
};
//get char value, translate to int, translate back into new char value
static char test_board_partial_16[16][16] = {
    {'2','0','9','0','8','0','=','0','<','0','>','0',':','0','?','0'},
    {'4','0','?','0','3','0','9','0','=','0','8','0','@','0','>','0'},
    {'1','0','6','0','?','0','5','0',';','0',':','0','3','0','8','0'},
    {'@','0','8','0','>','0',':','0','4','0','2','0','9','0','5','0'},
    {'<','0','@','0',':','0','?','0','8','0','5','0','6','0',';','0'},
    {'6','0','1','0','5','0','8','0','9','0','4','0','>','0','3','0'},
    {'>','0','4','0','6','0','1','0','@','0','7','0','8','0','2','0'},
    {'3','0',':','0','4','0','2','0','6','0','=','0','1','0','@','0'},
    {'=','0','2','0','7','0','>','0','3','0','?','0','<','0','1','0'},
    {'5','0','>','0','2','0','<','0',':','0',';','0','?','0','7','0'},
    {'7','0',';','0','@','0','3','0','5','0','9','0','2','0',':','0'},
    {':','0','3','0','9','0',';','0','2','0','<','0','4','0','=','0'},
    {';','0','=','0','1','0','7','0','?','0','6','0','5','0','<','0'},
    {'?','0','7','0','<','0','6','0','1','0','@','0',';','0','9','0'},
    {'8','0','5','0','=','0','@','0','>','0','<','0','7','0','4','0'},
    {'9','0','<','0',';','0','4','0','7','0','3','0','=','0','6','0'}
};


static char test_board_full_16[16][16] = {
    {'2',';','9','5','8','@','=','4','<','3','>','7',':','6','?','1'},
    {'4','<','?',';','3','6','9',';','=','5','8','1','@','7','>','2'},
    {'1','>','6','7','?','2','5','<',';','9',':','@','3','=','8','4'},
    {'@','=','8','3','>','1',':','7','4','6','2','?','9',';','5','<'},
    {'<','2','@','9',':','>','?','=','8','1','5','3','6','4',';','7'},
    {'6','7','1',';','5','<','8','@','9','?','4','2','>',';','3','='},
    {'>','5','4','=','6',';','1','3','@','<','7',':','8','9','2','?'},
    {'3','8',':','?','4','7','2','9','6','>','=',';','1','<','@','5'},
    {'=','9','2','@','7','8','>',';','3','4','?','6','<','5','1',';'},
    {'5','4','>','6','2','=','<','1',':','@',';','8','?','3','7','9'},
    {'7','1',';','<','@','4','3','?','5','=','9','>','2','8',':','6'},
    {':','?','3','8','9','5',';','6','2','7','<','1','4','>','=','@'},
    {';',';','=','>','1','9','7','8','?','2','6','4','5','@','<','3'},
    {'?','3','7','4','<',':','6','5','1','8','@','=',';','2','9','>'},
    {'8','6','5','1','=','3','@','2','>',';','<','9','7','?','4',':'},
    {'9','@','<','2',';','?','4','>','7',':','3','5','=','1','6','8'}
};

static char test_board_empty_25[25][25] = {
    {'0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0'},
    {'0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0'},
    {'0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0'},
    {'0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0'},
    {'0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0'},
    {'0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0'},
    {'0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0'},
    {'0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0'},
    {'0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0'},
    {'0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0'},
    {'0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0'},
    {'0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0'},
    {'0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0'},
    {'0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0'},
    {'0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0'},
    {'0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0'},
    {'0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0'},
    {'0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0'},
    {'0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0'},
    {'0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0'},
    {'0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0'},
    {'0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0'},
    {'0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0'},
    {'0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0'},
    {'0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0'}
};

static char test_board_partial_25[25][25] = {
    {'1','0','4','0','I','0','C','0','A','0','E','0','B','0','F','0','<','0','3','0','2','0','=','0','5'},
    {'5','0','C','0','H','0','F','0','9','0','@','0','7','0','A','0','E','0','>','0',':','0','4','0','?'},
    {'A','0','6','0','I','0','5','0','D','0',':','0','1','0','4','0','H','0','?','0','<','0','F','0','9'},
    {'@','0','E','0','<','0','2','0',';','0','5','0','?','0','<','0','D','0','F','0','9','0','I','0','3'},
    {':','0','?','0','F','0','1','0','6','0','G','0','I','0','3','0','5','0',';','0','8','0','D','0','A'},
    {'<','0',';','0','6','0','=','0','H','0','7','0','8','0','E','0','C','0','4','0','F','0','2','0','B'},
    {'8','0','=','0','9','0','4','0','<','0','?','0','5','0','D','0','A','0','B','0','1','0','7','0','6'},
    {'4','0','>','0','7','0','3','0','E','0','I','0','G','0','=','0','@','0','5','0','@','0',';','0','<'},
    {'F','0','H','0','G','0','D','0','1','0',':','0','4','0','>','0','2','0','5','0','C','0','I','0','9'},
    {'D','0','2','0','5','0','8','0','>','0','9','0','<','0','C','0','1','0','7','0','3','0','E','0','4'},
    {'=','0','3','0',':','0','G','0','4','0','F','0','A','0','H','0','7','0','9','0','<','0','6','0',';'},
    {'>','0','1','0','<','0','@','0','?','0','2','0','D','0',':','0','4','0','A','0','E','0','5','0','F'},
    {'7','0',';','0','D','0','E','0','9','0','4','0','<','0','2','0','>','0','5','0','=','0',':','0','B'},
    {'2','0','9','0',';','0',':','0','8','0','>','0','3','0','<','0','B','0','G','0','4','0','3','0','D'},
    {'6','0','D','0','4','0','<','0','5','0','B','0','G','0','9','0','2','0','I','0','7','0','H','0','>'},
    {'E','0','<','0','@','0',':','0','3','0','H','0','9','0',';','0','6','0','>','0','8','0','5','0','C'},
    {'9','0','8','0','1','0','I','0','D','0','A','0','3','0','B','0','@','0','5','0',';','0','?','0',':'},
    {'G','0','F','0','?','0','5','0','>','0','6','0','@','0',';','0','1','0','=','0','4','0','C','0','H'},
    {'I','0','6','0',';','0','1','0','8','0','=','0','C','0',':','0','<','0','D','0','B','0','@','0','A'},
    {'3','0','A','0','C','0','?','0','G','0',';','0','I','0','5','0','E','0','8','0','7','0','1','0','='},
    {'C','0','G','0','?','0','I','0','>','0','3','0','=','0',':','0','5','0','H','0','<','0','E','0','B'},
    {'?','0','5','0','>','0','7','0','C','0','D','0',';','0','I','0','9','0','<','0','B','0','6','0','1'},
    {';','0','7','0','D','0','6','0','2','0','H','0','=','0','1','0','I','0','8','0','>','0','9','0',':'},
    {'B','0','I','0','2','0','>','0','=','0','4','0','E','0','5','0','G','0','6','0','?','0','8','0','3'},
    {'H','0',':','0','=','0','9','0','@','0','C','0','6','0','8','0','>','0','2','0','G','0',';','0','1'}
};

static char test_board_full_25[25][25] = {
    {'7','G','5','?','4','B',';','I','<','E','F','H','D','9',':','1','C','3','8','=','A','6','>','2','@'},
    {'<','C','9','2','@','F','3','1',':','8','E','=','5','B','I','A','7','6','G','>','D','?','4','H',';'},
    {'3','D','6','B','H','7','5','G','=','A','C','?','>',';','1','4','F','@','9','2','I','8','<',':','E'},
    {'A','=','>','E','F','6','@','?','D','H','<','3','2','4','8','I','5',':','B',';','9','7','1','C','G'},
    {'8','I','1',':',';','2','C','4','9','>','G','6','7','@','A','E','?','H','D','<','5','F','B','3','='},
    {'H','7',';','4','G','@','F','8','2','?','6','E','C','3','D','=','A','<','I','1','>','B','9','5',':'},
    {'?',';','F','5','9','<','E','=','C','I','@','B','H','G',';','6','4','>','3','7','2','1','D','8','A'},
    {'D','8','@','I','<','>','4','6','7','B','A','F','=','1','2','5','G','9','H',':','?','3',';','E','C'},
    {'C','3','E','>','=','G','D',';','A','1',':','7','9','?','5','8','B','F','2','@','4','I','H','6','<'},
    {'B','2','A','1','6','9',':','3','H','5','>','8','4','I','<','?','D',';','C','E','7','@','G','=','F'},
    {'5','<','I','H','>','E','1','C','4','6','D','G','3','8','?','@','2','B','7','F',':','A','=',';','9'},
    {'6','1','B','=','A','D','G','H','@','2',';','I','E',':','7','9','<','8','5','4','3','>','C','F','?'},
    {'F','?',';','D','E','I','B','5','8','=','1','@','<','>','9','H','3','C',';','A','G','2','6','4','7'},
    {'2',';','3','@','8','A','7','F','>','9','4','C','B','H','=','G',':','?','1','6','<','D','E','I','5'},
    {'4','9','C','G','7',':','?','<',';','3','5','2','F','A','6','D','>','=','E','I','B','H','8','@','1'},
    {'9','@','2','A','3',';','6','D','E','F','7','4','?','C','B','>','I','5','=','H','1','G',':','<','8'},
    {'I','4','8','6','1','?','A','@','3','C','9','D',';','<','F','B','E','7',':','G','H','=','5','>','2'},
    {';','F','D','C','?','=','2','>','G','<','I','1',':','5','H','3','8','A','6','9','E','4','@','7','B'},
    {':','H','G','<','B','5','9','7','I','4','=','>','8','2','E','F','1','D','@','C','6',';','A','?','3'},
    {'E','>','=','7','5','H','8','B','1',':','3','A','@','6','G','<',';','2','4','?','C','9','F','D','I'},
    {'G','B','?','8','C','3','<','E','5',';','2','9','6','F','>','7','@','4','A','D','=',':','I','1','H'},
    {'=','E','<','3','2','1','>','9','6','7','B',';','G','D','C',':','H','I','F','8','@','5','?','A','4'},
    {'@','6','4','9','I','C','H','A','B','D','8',':','1','7','3',';','=','E','?','5','F','<','2','G','>'},
    {'1','5','7','F',':','8','I','2','?','@','H','<','A','=','4','C','6','G','>','B',';','E','3','9','D'},
    {'>','A','H',';','D','4','=',':','F','G','?','5','I','E','@','2','9','1','<','3','8','C','7','B','6'}

};

void test_unassigned(){
    N = 9;
    CU_ASSERT_EQUAL(count_unassigned(test_board_full_9), 0);
    CU_ASSERT_EQUAL(count_unassigned(test_board_partial_9), 51);
    CU_ASSERT_EQUAL(count_unassigned(test_board_empty_9), 81);

    N = 16;
    CU_ASSERT_EQUAL(count_unassigned(test_board_full_16), 0);
    CU_ASSERT_EQUAL(count_unassigned(test_board_partial_16), 128);
    CU_ASSERT_EQUAL(count_unassigned(test_board_empty_16), 256);

    N = 25;
    CU_ASSERT_EQUAL(count_unassigned(test_board_full_25), 0);
    CU_ASSERT_EQUAL(count_unassigned(test_board_partial_25), 300);
    CU_ASSERT_EQUAL(count_unassigned(test_board_empty_25), 625);
}

void test_set_destroy_unassigned(){
    N = 9;
    int n_unassigned = count_unassigned(test_board_partial_9);
    unAssigned_t **unassigned = set_unassigned(test_board_partial_9, n_unassigned);
    CU_ASSERT_PTR_NOT_NULL(unassigned);
    //First unassigned cell is at (0,2)
    CU_ASSERT_EQUAL(unassigned[0]->x, 2);
    CU_ASSERT_EQUAL(unassigned[0]->y, 0);
    //Last unassigned cell is at (8,6)
    CU_ASSERT_EQUAL(unassigned[n_unassigned-1]->x, 6);
    CU_ASSERT_EQUAL(unassigned[n_unassigned-1]->y, 8);
    destroy_unassigned(unassigned, n_unassigned);

    N = 16;
    n_unassigned = count_unassigned(test_board_partial_16);
    unAssigned_t **unassigned16 = set_unassigned(test_board_partial_16, n_unassigned);
    CU_ASSERT_PTR_NOT_NULL(unassigned16);
    //First unassigned cell is at (0,1)
    CU_ASSERT_EQUAL(unassigned16[0]->x, 1);
    CU_ASSERT_EQUAL(unassigned16[0]->y, 0);
    //Last unassigned cell is at (15,15)
    CU_ASSERT_EQUAL(unassigned16[n_unassigned-1]->x, 15);
    CU_ASSERT_EQUAL(unassigned16[n_unassigned-1]->y, 15);
    destroy_unassigned(unassigned16, n_unassigned);

    N = 25;
    n_unassigned = count_unassigned(test_board_partial_25);
    unAssigned_t **unassigned25 = set_unassigned(test_board_partial_25, n_unassigned);
    CU_ASSERT_PTR_NOT_NULL(unassigned25);
    //First unassigned cell is at (0,1)
    CU_ASSERT_EQUAL(unassigned25[0]->x, 1);
    CU_ASSERT_EQUAL(unassigned25[0]->y, 0);
    //Last unassigned cell is at (24,23)
    CU_ASSERT_EQUAL(unassigned25[n_unassigned-1]->x, 23);
    CU_ASSERT_EQUAL(unassigned25[n_unassigned-1]->y, 24);
    destroy_unassigned(unassigned25, n_unassigned);
}


/*At compile time, N has no value yet, so the compiler essentially sees board[0][0].
When you index board[i][j], you’re walking random memory → segfault or FPE.
The cleanest fix: make N a parameter to your functions, not a global, so you can reuse the same solver code for different Sudoku sizes.*/
void test_set_possibilities(){
    N = 9;
    char possibilities_9[9][9][9];
    set_possibilities(test_board_partial_9, possibilities_9);
    //Check possibilities for cell (0,2) which is unassigned
/*    CU_ASSERT_EQUAL(possibilities_9[0][2][0], '1');
    CU_ASSERT_EQUAL(possibilities_9[0][2][1], '2');
    CU_ASSERT_EQUAL(possibilities_9[0][2][2], '3');
    CU_ASSERT_EQUAL(possibilities_9[0][2][3], '4');
    CU_ASSERT_EQUAL(possibilities_9[0][2][4], '5');
    CU_ASSERT_EQUAL(possibilities_9[0][2][5], '6');
    CU_ASSERT_EQUAL(possibilities_9[0][2][6], '7');
    CU_ASSERT_EQUAL(possibilities_9[0][2][7], '8');
    CU_ASSERT_EQUAL(possibilities_9[0][2][8], '9');
*/
}
    

//////////////////////////////////////////////////////
int main()
{
    if (CU_initialize_registry() != CUE_SUCCESS)
        return CU_get_error();

    CU_pSuite logical_test_suite = CU_add_suite("Logical solver tests", init_suite, clean_suite);
    if ((logical_test_suite == NULL))
    {
        CU_cleanup_registry();
        return CU_get_error();
    }

    if (
        //(CU_add_test(store_test_suite, "Create and destroy store", test_create_destroy_store) == NULL) ||
        //(CU_add_test(store_test_suite, "Add and remove merchandise", test_add_remove_merch) == NULL) ||        
        (CU_add_test(logical_test_suite, "Count unassigned cells", test_unassigned) == NULL) ||
        (CU_add_test(logical_test_suite, "Set and destroy unassigned cells", test_set_destroy_unassigned) == NULL) ||
        (CU_add_test(logical_test_suite, "Set possibilities for each cell", test_set_possibilities) == NULL) ||
        0)
    {
        CU_cleanup_registry();
        return CU_get_error();
    }

    CU_basic_set_mode(CU_BRM_VERBOSE);
    CU_basic_run_tests();
    CU_cleanup_registry();
    return CU_get_error();
}
